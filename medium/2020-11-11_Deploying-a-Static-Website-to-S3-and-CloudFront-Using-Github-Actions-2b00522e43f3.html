<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Deploying a Static Website to S3 and CloudFront Using Github Actions</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Deploying a Static Website to S3 and CloudFront Using Github Actions</h1>
</header>
<section data-field="subtitle" class="p-summary">
Introduction
</section>
<section data-field="body" class="e-content">
<section name="84c9" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="b888" id="b888" class="graf graf--h3 graf--leading graf--title">Deploying a Static Website to S3 and CloudFront Using Github Actions</h3><h4 name="4a41" id="4a41" class="graf graf--h4 graf-after--h3 graf--subtitle">An outline of how I automated the deployment of my personal site.</h4><h3 name="93cd" id="93cd" class="graf graf--h3 graf-after--h4">Introduction</h3><p name="9850" id="9850" class="graf graf--p graf-after--h3">A while back I set up a personal website for myself. It was left for a while and recently I made some improvements to it. As I was doing the improvements I decided to write up how it was built since there were certain aspects of the work I found interesting.</p><p name="4d93" id="4d93" class="graf graf--p graf-after--p">There are similar stories out there like this <a href="https://read.acloud.guru/scaling-your-static-site-to-a-global-market-for-a-fraction-of-the-cost-on-aws-12d23f30f877" data-href="https://read.acloud.guru/scaling-your-static-site-to-a-global-market-for-a-fraction-of-the-cost-on-aws-12d23f30f877" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">one</a> or this <a href="https://medium.com/@joecrobak/production-deploy-of-a-single-page-app-using-s3-and-cloudfront-d4aa2d170aa3" data-href="https://medium.com/@joecrobak/production-deploy-of-a-single-page-app-using-s3-and-cloudfront-d4aa2d170aa3" class="markup--anchor markup--p-anchor" target="_blank">one</a>. However, their setup is a bit different or does not go into some details I cover. <em class="markup--em markup--p-em">Plus it never hurts to have additional resources when you are building something.</em></p><p name="3a81" id="3a81" class="graf graf--p graf-after--p">When I first started, all I needed was some static assets which I could change on occasion, therefore, I did not need a server running all the time. I decided to deploy through AWS since I’m more familiar with this setup and it was relatively cheap. One of the improvements I made to it recently was using Github actions for deployments since I had to move code over to a new laptop.</p><p name="fca0" id="fca0" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">I do not claim this is the cheapest or best option. It was good enough for me given what I wanted and what I was most familiar with.</em></p><h3 name="eba8" id="eba8" class="graf graf--h3 graf-after--p">AWS Resources</h3><figure name="daf5" id="daf5" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="1*93aGNN5kaBc2A_HywG6iKQ.png" data-width="1452" data-height="433" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*93aGNN5kaBc2A_HywG6iKQ.png"><figcaption class="imageCaption">Linking it all together. Right: <a href="https://medium.com/@matthewmanuel/hosting-a-https-static-website-on-amazon-s3-w-cloudfront-and-route-53-f347a16b6a91" data-href="https://medium.com/@matthewmanuel/hosting-a-https-static-website-on-amazon-s3-w-cloudfront-and-route-53-f347a16b6a91" class="markup--anchor markup--figure-anchor" target="_blank">source</a></figcaption></figure><p name="0f49" id="0f49" class="graf graf--p graf-after--figure">The full setup can be seen above going from the browser to the static assets with each part built using Github actions. The nice thing about this is we can replace each component with another none AWS service if required.</p><h4 name="3b0e" id="3b0e" class="graf graf--h4 graf-after--p">Route53</h4><figure name="beb5" id="beb5" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="1*nwvZf75GQHv0o-tHqWm_fQ.png" data-width="192" data-height="130" src="https://cdn-images-1.medium.com/max/800/1*nwvZf75GQHv0o-tHqWm_fQ.png"><figcaption class="imageCaption">Welcome to Route53. Rights: <a href="https://aws.amazon.com/route53/" data-href="https://aws.amazon.com/route53/" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">source</a></figcaption></figure><blockquote name="6947" id="6947" class="graf graf--blockquote graf-after--figure">Amazon Route 53 is a highly available and scalable cloud <a href="https://aws.amazon.com/route53/what-is-dns/" data-href="https://aws.amazon.com/route53/what-is-dns/" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank">Domain Name System (DNS)</a> web service.</blockquote><p name="3207" id="3207" class="graf graf--p graf-after--blockquote">Route53 is a nice service which integrates well with other AWS services. However, for a simple DNS service most of these are not needed. It is also expensive if you only use it for a small website; which I do. If you check out the cost below you have to pay 50 cents per month for a hosted zone; this is not a huge amount but if you use another solution you could get this for free.</p><p name="8b73" id="8b73" class="graf graf--p graf-after--p">I originally had the domain registered in Namecheap but moved it over since I was working with a lot of stuff in AWS. Looking at the cost for what I get I’m regretting doing this. At this point though it would be more pain to move over and you never know what functionality you might need.</p><p name="78fb" id="78fb" class="graf graf--p graf-after--p">With that said, Route53 has worked well for the majority of the projects I have worked on using some of the features mentioned below.</p><ul class="postList"><li name="8d7d" id="8d7d" class="graf graf--li graf-after--p">VPC DNS routing</li><li name="6ac8" id="6ac8" class="graf graf--li graf-after--li">Health Checking</li><li name="8d10" id="8d10" class="graf graf--li graf-after--li">Geo Routing</li><li name="9059" id="9059" class="graf graf--li graf-after--li">AWS Certificate Manager</li></ul><p name="14f6" id="14f6" class="graf graf--p graf-after--li">These features quickly pay for themselves for a site with any level of traffic.</p><p name="a563" id="a563" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Cost:</strong></p><ul class="postList"><li name="acc5" id="acc5" class="graf graf--li graf-after--p">$0.50 per hosted zone</li><li name="489f" id="489f" class="graf graf--li graf-after--li">$0.40 per million queries — first 1 Billion queries / month</li></ul><h4 name="6ba3" id="6ba3" class="graf graf--h4 graf-after--li">CloudFront</h4><figure name="6b53" id="6b53" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="1*ZitRPstFKx3016JsykcjXA.png" data-width="545" data-height="194" src="https://cdn-images-1.medium.com/max/800/1*ZitRPstFKx3016JsykcjXA.png"><figcaption class="imageCaption">CloudFront working with Lambda Edge. Rights: <a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-edge.html" data-href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-edge.html" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">source</a></figcaption></figure><blockquote name="2866" id="2866" class="graf graf--blockquote graf-after--figure">Amazon CloudFront is a fast content delivery network (CDN) service that securely delivers data, videos, applications, and APIs to customers globally with low latency, high transfer speeds, all within a developer-friendly environment. CloudFront is integrated with AWS — both physical locations that are directly connected to the AWS global infrastructure, as well as other AWS services.</blockquote><p name="ae31" id="ae31" class="graf graf--p graf-after--blockquote">When I first started working with CloudFront I was really impressed. It gave me so much control over my CDN and allowed me to distribute my website all over the world. Also the ability to use this as the first port of call for all sorts of AWS service easily was great: EC2, ELB, APIGW, S3…. Which are also free to fetch from with CloudFront and stays within the AWS network.</p><p name="df25" id="df25" class="graf graf--p graf-after--p">Lambda@Edge allows you to use serverless computing power at the location you serve your content. They are incredibly useful for all sort of tasks; this can range from simple header manipulation, rerouting or complex authentication mechanisms for static assets. There are four CloudFront stages which can call Lambda@Edge</p><ul class="postList"><li name="11fb" id="11fb" class="graf graf--li graf-after--p">Viewer Request</li><li name="5901" id="5901" class="graf graf--li graf-after--li">Viewer Response</li><li name="6e50" id="6e50" class="graf graf--li graf-after--li">Origin Request</li><li name="1321" id="1321" class="graf graf--li graf-after--li">Origin Response</li></ul><p name="a60d" id="a60d" class="graf graf--p graf-after--li">As you can guess, viewer calls for each request to CloudFront, Origin calls for fetches to the static assets origin.</p><p name="9ba1" id="9ba1" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Be careful with viewer calls since Lambda@Edge is more expensive than normal lambda functions and will be executed for all requests</strong></p><p name="ffaf" id="ffaf" class="graf graf--p graf-after--p"><a href="https://aws.amazon.com/shield/?whats-new-cards.sort-by=item.additionalFields.postDateTime&amp;whats-new-cards.sort-order=desc" data-href="https://aws.amazon.com/shield/?whats-new-cards.sort-by=item.additionalFields.postDateTime&amp;whats-new-cards.sort-order=desc" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">AWS Shield</a> Standard comes at no additional cost which is great</p><blockquote name="924b" id="924b" class="graf graf--blockquote graf-after--p">All AWS customers benefit from the automatic protections of AWS Shield Standard, at no additional charge. AWS Shield Standard defends against most common, frequently occurring network and transport layer DDoS attacks that target your web site or applications. When you use AWS Shield Standard with <a href="https://aws.amazon.com/cloudfront/" data-href="https://aws.amazon.com/cloudfront/" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank">Amazon CloudFront</a> and Amazon Route 53, you receive comprehensive availability protection against all known infrastructure (Layer 3 and 4) attacks.</blockquote><p name="6e17" id="6e17" class="graf graf--p graf-after--blockquote">One issue using CloudFront for small projects is it can be a lot more expensive than other services like Cloudflare. I use AWS everyday so this did not put me off, since it would take me a day or so to set this up, rather than sitting learning how Cloudflare worked; plus I don’t have much traffic to really cost me a lot. However, if I was looking to optimise on a small to medium size website I would suggest not using it since the network costs could be more than you are making. This all depends on what you are doing in the end. Even a small website might need to have a bit more control over how the CDN works so CloudFront might be the only option you have.</p><p name="d305" id="d305" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Cost:</strong></p><ul class="postList"><li name="faac" id="faac" class="graf graf--li graf-after--p">Regional data transfer out to internet for most expensive region (India) $0.170 per GB for under 10 TB.</li><li name="7a3c" id="7a3c" class="graf graf--li graf-after--li">Regional Data Transfer Out to Origin for most expensive region (India) $0.160 (Free for AWS origin but still pay for what the origin charges)</li><li name="865f" id="865f" class="graf graf--li graf-after--li">Request Pricing for All HTTP Methods $0.0220 per 10,000</li><li name="d24b" id="d24b" class="graf graf--li graf-after--li">No additional charge for the first 1,000 paths requested for invalidation each month. Thereafter, $0.005 per path requested for invalidation.</li><li name="94f7" id="94f7" class="graf graf--li graf-after--li">$0.60 per 1 million requests for lambda edge and $0.00001667 per GB-s for 128MB</li></ul><h4 name="35bd" id="35bd" class="graf graf--h4 graf-after--li">s3</h4><figure name="6be0" id="6be0" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="1*Y9c3aK4t-uMu-UqBrgOI5A.png" data-width="180" data-height="130" src="https://cdn-images-1.medium.com/max/800/1*Y9c3aK4t-uMu-UqBrgOI5A.png"><figcaption class="imageCaption">Welcome to S3. Right: <a href="https://aws.amazon.com/s3/" data-href="https://aws.amazon.com/s3/" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">source</a></figcaption></figure><blockquote name="1589" id="1589" class="graf graf--blockquote graf-after--figure">Amazon Simple Storage Service (Amazon S3) is an object storage service that offers industry-leading scalability, data availability, security, and performance.</blockquote><p name="512a" id="512a" class="graf graf--p graf-after--blockquote">Storage in AWS can be confusing to the uninitiated. You will come across three options most of the time. In simple terms you should see it as such</p><ul class="postList"><li name="fd77" id="fd77" class="graf graf--li graf-after--p">S3: Object storage</li><li name="5353" id="5353" class="graf graf--li graf-after--li">EBS: Hard disk</li><li name="f74b" id="f74b" class="graf graf--li graf-after--li">EFS: Network Storage</li></ul><p name="ee00" id="ee00" class="graf graf--p graf-after--li">You can of course combine EBS volumes to form your own network storage like Gluster. For simple static asset storage you should not even consider EBS or EFS, S3 is perfect for it. Additionally, S3 buckets and objects can be moved between different price classes depending on how often you access the data. For a simple website this is not even a consideration, but when moving to more complex problems like log storage, versioning etc it can be useful. Also access control is much easier to manage if you are already using AWS services. You can even setup VPC endpoints to ensure your data is only available within your private network.</p><p name="7463" id="7463" class="graf graf--p graf-after--p">S3 is relatively cheap for what you get in return. In addition you do not pay for moving data between AWS services.</p><p name="9d84" id="9d84" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Cost:</strong></p><ul class="postList"><li name="1312" id="1312" class="graf graf--li graf-after--p">$0.023 per GB for first 50TB in US-EAST</li><li name="eff9" id="eff9" class="graf graf--li graf-after--li">PUT, COPY, POST, LIST requests (per 1,000 requests) $0.005</li><li name="cfb9" id="cfb9" class="graf graf--li graf-after--li">GET, SELECT, and all other requests (per 1,000 requests) $0.0004</li><li name="0e8d" id="0e8d" class="graf graf--li graf-after--li">Free for data transfer in</li><li name="75b2" id="75b2" class="graf graf--li graf-after--li">Free for data transferred to cloudfront</li></ul><h4 name="a616" id="a616" class="graf graf--h4 graf-after--li">SES</h4><figure name="e89d" id="e89d" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="1*snhCFX4Jf-lLf1KwKeqIMg.png" data-width="820" data-height="220" src="https://cdn-images-1.medium.com/max/800/1*snhCFX4Jf-lLf1KwKeqIMg.png"><figcaption class="imageCaption">Setup to let people send messages from your website. Rights: <a href="https://aws.amazon.com/blogs/architecture/create-dynamic-contact-forms-for-s3-static-websites-using-aws-lambda-amazon-api-gateway-and-amazon-ses/" data-href="https://aws.amazon.com/blogs/architecture/create-dynamic-contact-forms-for-s3-static-websites-using-aws-lambda-amazon-api-gateway-and-amazon-ses/" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">source</a></figcaption></figure><blockquote name="d52a" id="d52a" class="graf graf--blockquote graf-after--figure">Amazon Simple Email Service (SES) is a cost-effective, flexible, and scalable email service that enables developers to send mail from within any application.</blockquote><p name="ee7d" id="ee7d" class="graf graf--p graf-after--blockquote">SES is perfect for a simple contact form. There is a nice tutorial <a href="https://aws.amazon.com/blogs/architecture/create-dynamic-contact-forms-for-s3-static-websites-using-aws-lambda-amazon-api-gateway-and-amazon-ses/" data-href="https://aws.amazon.com/blogs/architecture/create-dynamic-contact-forms-for-s3-static-websites-using-aws-lambda-amazon-api-gateway-and-amazon-ses/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">here</a> demonstrating this which I followed for my site. I am no expert on the alternatives but since it is effectively free for what I need then it is a no brainer.</p><p name="3695" id="3695" class="graf graf--p graf-after--p">The setup is also relatively simple with your email having to be verified before you can use that email address. After this you link your frontend code to send your message to APIGW which will trigger a lambda which will trigger SES to send an email.</p><p name="f0be" id="f0be" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Cost:</strong></p><ul class="postList"><li name="e928" id="e928" class="graf graf--li graf-after--p">Since sending email from lambda: $0 for the first 62,000 emails you send each month, and $0.10 for every 1,000 emails you send after that.</li></ul><h3 name="c637" id="c637" class="graf graf--h3 graf-after--li">Setup</h3><p name="755a" id="755a" class="graf graf--p graf-after--h3">All infrastructure described above was created using terraform. First we need to create CloudFront with Lambda@Edge and then the S3 bucket. Below you will see a gist for this setup. This lives as a separate reusable terraform module. The module is setup to allow different</p><ul class="postList"><li name="0438" id="0438" class="graf graf--li graf-after--p">AWS Lambda@Edge Functions</li><li name="e759" id="e759" class="graf graf--li graf-after--li">Static Assets (Depending on the name of the S3 bucket)</li><li name="3aae" id="3aae" class="graf graf--li graf-after--li">Multiple Domain Names</li></ul><p name="8d14" id="8d14" class="graf graf--p graf-after--li">The Lambda@Edge functions are automatically compiled if any change is detected.</p><figure name="1b96" id="1b96" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mortonprod/bf46389518baeed80fdae2becd45e307.js.js"></script></figure><p name="c2c6" id="c2c6" class="graf graf--p graf-after--figure">The Lambda@Edge functions must be attached with the correct versions. This update can take sometime for the lambda to propagate over the world.</p><p name="a0f1" id="a0f1" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Be aware you might have to rerun the terraform apply if you have an issue with the propagation.</strong></p><figure name="3c8e" id="3c8e" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*NzMNT2r-SZo5SPp5spsXHQ.jpeg" data-width="1009" data-height="240" src="https://cdn-images-1.medium.com/max/800/1*NzMNT2r-SZo5SPp5spsXHQ.jpeg"><figcaption class="imageCaption">Note the lambda function version number 15 is specified</figcaption></figure><p name="5180" id="5180" class="graf graf--p graf-after--figure">The Lambda@Edge functions which are used for the CloudFront distribution are bundled into a single block of code for ease.</p><p name="f315" id="f315" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">If your own Lambda functions are large then split them into parts, otherwise you will be uploading more code in each execution than you need.</strong></p><p name="d341" id="d341" class="graf graf--p graf-after--p">Below you can see we are doing basic rerouting for the origin request. Another option for this simple case would have been to use the default origin setting in CloudFront. However, I already had the code for this from another project, so I included it encase I needed to do more complex routing in the future.</p><p name="08b9" id="08b9" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Important to note that these function are only called when CloudFront refreshes not when the viewer requests the page.</strong></p><p name="a9f7" id="a9f7" class="graf graf--p graf-after--p">I also update the response from the origin with the security headers which we can’t add to s3. Lastly I reroute any failed requests to the index page so users who type in the wrong url will still get to the page. Another option would have been using CloudFronts error pages but since we are already using Lambda@Edge is is simpler to place here.</p><figure name="8e56" id="8e56" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mortonprod/503a95446f8ac4baa5564a484068d885.js"></script></figure><p name="6e33" id="6e33" class="graf graf--p graf-after--figure">The files above are in one Github repository which are imported into another repository using Github modules. This is done to link the version histories between multiple repositories, but also to keep source code bloat in a single repository to a minimum. Another option would have been to use terraform module versioning. However, the static assets were already imported through Github modules so it made sense to do this with the CloudFront-S3 module. Another factor is that I would have to manually update the terraform module version for each change which would be overkill.</p><p name="4f05" id="4f05" class="graf graf--p graf-after--p">The module below uses the standard S3 store to keep state information and Dynamodb for state locking. The version of terraform is quite old hence the old terraform syntax. Terraform could have been updated, however, this would have been more effort than it’s worth.</p><p name="2325" id="2325" class="graf graf--p graf-after--p">Lastly you can see APIGW triggering a lambda which calls SES. The SES service was setup independently from terraform and simply referenced.</p><figure name="fca3" id="fca3" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mortonprod/7f1eda93438b2a581e24cd2ac2134f26.js"></script></figure><h4 name="a84b" id="a84b" class="graf graf--h4 graf-after--figure">Static Assets</h4><p name="acb7" id="acb7" class="graf graf--p graf-after--h4">The website used a template from material design lite by google. The final build is pulled together using Webpack which gaves me quite a few benefits even for such a simple site.</p><ul class="postList"><li name="7bc4" id="7bc4" class="graf graf--li graf-after--p">Asset placement in bottom or top of HTML file</li><li name="b833" id="b833" class="graf graf--li graf-after--li">Asset renamed for each build so the cache refreshes.</li><li name="1cac" id="1cac" class="graf graf--li graf-after--li">Image minimisation and compression</li><li name="46d6" id="46d6" class="graf graf--li graf-after--li">Allows Webpack dev server to be used for development.</li><li name="9208" id="9208" class="graf graf--li graf-after--li">CSS and JS minimisation and uglification.</li><li name="14fc" id="14fc" class="graf graf--li graf-after--li">Chunks are also included but not needed for such small amounts of code</li><li name="ed7b" id="ed7b" class="graf graf--li graf-after--li">External dependencies defined so we don’t have to push down frameworks like jQuery from our CDN.</li></ul><figure name="f321" id="f321" class="graf graf--figure graf--iframe graf-after--li"><script src="https://gist.github.com/mortonprod/7da02b7de88bdf482909d94f48385f61.js"></script></figure><p name="6894" id="6894" class="graf graf--p graf-after--figure">Running the build we get everything built as expected</p><figure name="c7a0" id="c7a0" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*uHezWqie5K7doeJ5DfOkOA.jpeg" data-width="888" data-height="691" src="https://cdn-images-1.medium.com/max/800/1*uHezWqie5K7doeJ5DfOkOA.jpeg"><figcaption class="imageCaption">Example output from Webpack build.</figcaption></figure><h4 name="b9a8" id="b9a8" class="graf graf--h4 graf-after--figure">Github Actions</h4><p name="09fe" id="09fe" class="graf graf--p graf-after--h4">Github provides</p><blockquote name="4d43" id="4d43" class="graf graf--blockquote graf-after--p">2,000 Actions minutes/month</blockquote><blockquote name="ee54" id="ee54" class="graf graf--blockquote graf-after--blockquote">Free for public repositories</blockquote><p name="14af" id="14af" class="graf graf--p graf-after--blockquote">which is amazing in my opinion.</p><p name="57a9" id="57a9" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">It means you can build, deploy and host all your code on Github. Which is perfect for small projects. I would even consider going this way for this project if I had the time or could be bothered to start again.</em></p><p name="27bf" id="27bf" class="graf graf--p graf-after--p">Another benefit is you don’t have to deploy or manage your own servers like with bamboo or gitlab. The management of these servers at scale can be an issue in themselves. However, if you are looking at these solution you are probably looking at large complex deployments which cover lots of regions all over the world so Github action would not be ideal.</p><p name="11c4" id="11c4" class="graf graf--p graf-after--p">I found the setup of the Github actions a little strange to begin with but quite quickly it made sense. You can use VMs or containerised environments made by others, or use your own. You pass secrets as env variables which are never exposed to anyone except you. <em class="markup--em markup--p-em">Which having on Github made me paranoid.</em> You can then write your own deployment scripts which you call from the yaml file which describes the workflow.</p><p name="232b" id="232b" class="graf graf--p graf-after--p">Below you can see that we only deploy when we push a tag to the repo. This allows us to limit deployments when we version and running terraform plan whenever do a general push to master, using a different workflow described in a different yaml file.</p><figure name="b70e" id="b70e" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mortonprod/4f8f8b092ed57b80b6de75cbbdf22ca6.js"></script></figure><p name="5b42" id="5b42" class="graf graf--p graf-after--figure">You can then see the pipeline running below.</p><p name="3902" id="3902" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">You might ask if you should have a pipeline for such a small project. Personally I would have a pipeline for every project I built. It does not always work out that way but if I come back to it after sometime and my laptop has changed or someone else wants to have a look it is always a pain to get started again. Having a pipelines with a pristine env and deployment strategy makes it so much easier</em></p><figure name="7a7c" id="7a7c" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*sezeTlXWSq-oL32JS9A3NA.jpeg" data-width="909" data-height="395" src="https://cdn-images-1.medium.com/max/800/1*sezeTlXWSq-oL32JS9A3NA.jpeg"><figcaption class="imageCaption">Example pipelines from Github.</figcaption></figure><p name="6d34" id="6d34" class="graf graf--p graf-after--figure">The pipeline also invalidates the cache for CloudFront. Since we don’t cache the HTML files this is not really required but kept in since I don’t use anywhere near the free allotted invalidations per month.</p><figure name="25e1" id="25e1" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*x9Gi7-M1V4_m1WKaieclOQ.jpeg" data-width="986" data-height="330" src="https://cdn-images-1.medium.com/max/800/1*x9Gi7-M1V4_m1WKaieclOQ.jpeg"></figure><p name="4de8" id="4de8" class="graf graf--p graf-after--figure">Cache settings for the browser are set in the Lambda@Edge shown in the node code above. You can see in the pipeline we also setcache settings in S3. These cache settings will effect how CloudFront caches.</p><figure name="cc75" id="cc75" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*sDiOFZaDEggJ3pVl8gXo-w.jpeg" data-width="886" data-height="229" src="https://cdn-images-1.medium.com/max/800/1*sDiOFZaDEggJ3pVl8gXo-w.jpeg"><figcaption class="imageCaption">Cache settings in S3 for html pages so we never cache. Different settings used for other assets.</figcaption></figure><p name="41cc" id="41cc" class="graf graf--p graf-after--figure">Finally we set the cache in CloudFront. We specify a min TTL of 0 so CloudFront will always pull from the origin for HTML pages. We also set a large max TTL so the S3 cache value tells CloudFront to keep the assets for about a month.</p><figure name="3f3a" id="3f3a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*T_LRQx3RdzbUpO6hnIFF3Q.jpeg" data-width="404" data-height="129" src="https://cdn-images-1.medium.com/max/800/1*T_LRQx3RdzbUpO6hnIFF3Q.jpeg"><figcaption class="imageCaption">Cache settings in CloudFront which were set in terraform</figcaption></figure><p name="33f7" id="33f7" class="graf graf--p graf-after--figure">You can check the settings to make sure everything is working as expected:</p><figure name="2a31" id="2a31" class="graf graf--figure graf--layoutOutsetLeft graf-after--p"><img class="graf-image" data-image-id="1*zT9ti44SANxv5gkAexVedw.jpeg" data-width="289" data-height="66" src="https://cdn-images-1.medium.com/max/600/1*zT9ti44SANxv5gkAexVedw.jpeg"><figcaption class="imageCaption">Cache set for html files</figcaption></figure><figure name="0091" id="0091" class="graf graf--figure graf--layoutOutsetLeft graf-after--figure"><img class="graf-image" data-image-id="1*q1jmou2CqEYZfbrYGGPDUg.jpeg" data-width="316" data-height="36" src="https://cdn-images-1.medium.com/max/600/1*q1jmou2CqEYZfbrYGGPDUg.jpeg"><figcaption class="imageCaption">Response from CloudFront</figcaption></figure><figure name="889d" id="889d" class="graf graf--figure graf--layoutOutsetLeft graf-after--figure"><img class="graf-image" data-image-id="1*gZrDyf-9agxDOM9D_V5qEA.jpeg" data-width="280" data-height="36" src="https://cdn-images-1.medium.com/max/600/1*gZrDyf-9agxDOM9D_V5qEA.jpeg"><figcaption class="imageCaption">Set long cache time for all assets</figcaption></figure><figure name="e237" id="e237" class="graf graf--figure graf--layoutOutsetLeft graf-after--figure"><img class="graf-image" data-image-id="1*TQ1qUjAY3aX78DwEUOC0lw.jpeg" data-width="274" data-height="35" src="https://cdn-images-1.medium.com/max/600/1*TQ1qUjAY3aX78DwEUOC0lw.jpeg"><figcaption class="imageCaption">Response from CloudFront</figcaption></figure><p name="58d2" id="58d2" class="graf graf--p graf-after--figure">We don’t want the HTML pages cached but static assets to be cached so we set both settings:</p><pre name="7167" id="7167" class="graf graf--pre graf-after--p">Cache-Control:no-cache (HTML)<br>OR<br>Cache-Control:max-age=31536000 (Assets)</pre><p name="1aad" id="1aad" class="graf graf--p graf-after--pre">When the new index file is sent back down to the browser all assets have new ids so those assets are pulled. This ensures browsers get the most recent changes from the origin with a simple refresh.</p><figure name="26a7" id="26a7" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*6-SJVw6SeXh8CeaEoYdF1g.jpeg" data-width="332" data-height="264" src="https://cdn-images-1.medium.com/max/800/1*6-SJVw6SeXh8CeaEoYdF1g.jpeg"><figcaption class="imageCaption">Resource names generated by Webpack.</figcaption></figure><h3 name="4bd7" id="4bd7" class="graf graf--h3 graf-after--figure">Conclusion</h3><p name="7284" id="7284" class="graf graf--p graf-after--h3">You can see the website <a href="https://alexandermorton.co.uk/" data-href="https://alexandermorton.co.uk/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">here</a>.</p><p name="bd0c" id="bd0c" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">If I was starting again I probably would not use the setup above. Which is a strange thing to say as a conclusion; there are a lot simpler and cheaper solutions.</em></p><p name="63be" id="63be" class="graf graf--p graf-after--p">It just made sense at the time since I was already building something similar for another project I was working on, so I knew how to quickly throw it up. I also liked the control I would get from the solution; meaning, if I wanted to, I could more easily expand functionality.</p><p name="592a" id="592a" class="graf graf--p graf-after--p">The full setup can be found in <a href="https://github.com/mortonprod/be-personal-site" data-href="https://github.com/mortonprod/be-personal-site" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">this</a> repository including the pipeline.</p><p name="1f2f" id="1f2f" class="graf graf--p graf-after--p graf--trailing">Hopefully this information is useful to anyone looking to build something similar with the tools described here.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@mortonprod" class="p-author h-card">Alexander Morton</a> on <a href="https://medium.com/p/2b00522e43f3"><time class="dt-published" datetime="2020-11-11T08:49:41.985Z">November 11, 2020</time></a>.</p><p><a href="https://medium.com/@mortonprod/deploying-a-static-website-to-s3-and-cloudfront-using-github-actions-2b00522e43f3" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 24, 2021.</p></footer></article></body></html>